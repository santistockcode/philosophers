#  TODO: Testing philo outcome by using python's pexpect
[tox]
envlist = unit, integration-backend, integration-frontend
skipsdist = True
isolated_build = False

[testenv]
description = Base environment configuration
deps =
    pytest>=7.0
    pytest-timeout>=2.1.0
    pexpect>=4.8.0
setenv =
    MINISHELL_ROOT = {toxinidir}
    LIBFT_DIR = {toxinidir}/Libft
    TEST_SUPPORT_DIR = {toxinidir}/tests/support
passenv =
    HOME
    USER
    PATH
    TERM
allowlist_externals =
    make
    cc
    rm
    bash
    find
    cat
    ./tests/integration/apis/test_runner_exec

# ============================================================================
# Unit Tests (C with minunit)
# ============================================================================

[testenv:unit]
description = Run C unit tests using minunit
commands_pre =
    ; Build libft
    make -C {env:LIBFT_DIR}
commands =
    ; Run compiled unit tests
    python {toxinidir}/tests/support/scripts/compile_unit_tests.py --run

[testenv:unit-keep]
description = Run unit tests and keep compiled binaries
commands = {[testenv:unit]commands} --keep_bin --debug

[testenv:unit-keep-debug]
description = Run unit tests and keep compiled binaries for debugging
commands = {[testenv:unit]commands} --keep_bin --debug

[testenv:unit-valgrind]
description = Run unit tests under Valgrind
commands = {[testenv:unit]commands} --valgrind

[testenv:unit-val-script]
description = Keep compiled binaries but exec without debug flags
commands = {[testenv:unit]commands} --keep_bin

[testenv:unit-clean]
description = Clean up executables and valgrind logs
commands =
    rm -rf {toxinidir}/tests/unit/execution/bin/valgrind-fds-results
    rm -rf {toxinidir}/tests/unit/execution/bin/valgrind-leaks-results
    rm -rf {toxinidir}/tests/unit/execution/bin

# ============================================================================
# Integration Tests - Backend
# ============================================================================

[testenv:integration-backend]
description = Run backend integration tests (execution engine)
commands_pre =
    ; Build libft
    make -C {env:LIBFT_DIR}
    ; Compile test API shared library
    python {toxinidir}/tests/support/scripts/compile_integration_api.py --runner
    ; Include all ib-* testenv commands
commands = 
    {[testenv:ib-hds]commands}
    {[testenv:ib-ep]commands}
    {[testenv:ib-es]commands}
commands_post =
    ; Cleanup
    python {toxinidir}/tests/support/scripts/compile_integration_api.py --clean

[testenv:runner-exec]
description = Run c runner for exec part
commands_pre = {[testenv:integration-backend]commands_pre} --runner
commands = ./tests/integration/apis/test_runner_exec

[testenv:ib-hds]
description = Run only heredoc tests
commands_pre = {[testenv:integration-backend]commands_pre} --runner
commands =
    pytest -s tests/integration/backend/test_here_docs.py -v
commands_post = 
    ; Don't cleanup so I can debug da thing

[testenv:ib-ep]
description = Run only exec pipeline tests
commands_pre = {[testenv:integration-backend]commands_pre} --runner
commands =
    pytest -s tests/integration/backend/test_exec_pipeline.py -v
commands_post =
    ; Don't cleanup so I can debug da thing

[testenv:ib-es]
description = Run only exec simple tests
commands_pre = {[testenv:integration-backend]commands_pre} --runner
commands =
    pytest -s tests/integration/backend/test_exec_simple.py -v
commands_post =

# ============================================================================
# Integration Tests - Frontend
# ============================================================================

[testenv:integration-frontend]
description = Run frontend integration tests (parser/lexer)
commands =
    pytest {posargs:tests/integration/frontend} -v

# ============================================================================
# Manual/Interactive Tests
# ============================================================================

# TODO: Manual/Interactive Tests

# ============================================================================
# Combined Test Runs
# ============================================================================

[testenv:all]
description = Run all automated tests (unit + integration)
commands =
    {[testenv:unit]commands_pre}
    {[testenv:unit]commands}
    {[testenv:integration-backend]commands_pre}
    {[testenv:integration-backend]commands}
    {[testenv:integration-frontend]commands}
commands_post =
    {[testenv:integration-backend]commands_post}


# ============================================================================
# Cleanup
# ============================================================================

[testenv:clean]
description = Clean all test artifacts
commands =
    python {toxinidir}/tests/support/scripts/compile_integration_api.py --clean
    rm -rf .tox
    rm -rf .pytest_cache
    rm -f .here_doc_*
    find {toxinidir} -type d -name "__pycache__" -exec rm -rf {} +